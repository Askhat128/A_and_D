<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Опросник</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: url('фон_здесь.jpg') no-repeat center center fixed;
    background-size: cover;
    color: #222;
    padding: 20px;
  }
  form {
    background: rgba(255, 255, 255, 0.9);
    max-width: 600px;
    margin: auto;
    padding: 20px;
    border-radius: 10px;
  }
  label {
    display: block;
    margin-top: 15px;
  }
  input[type="text"], textarea, select {
    width: 100%;
    padding: 7px;
    margin-top: 5px;
    box-sizing: border-box;
  }
  .guest-block {
    margin-left: 20px;
    margin-top: 15px;
    padding: 10px;
    border: 1px solid #ccc;
    border-radius: 8px;
    background: #f9f9f9;
  }
  .guest-block h4 {
    margin: 0 0 10px 0;
  }
  button:disabled {
    background: #aaa;
    cursor: not-allowed;
  }
  button {
    margin-top: 20px;
    padding: 10px 20px;
    font-size: 1rem;
    background: #007BFF;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
  }
</style>
</head>
<body>

<form id="surveyForm">
  <h2>Пожалуйста, заполните опрос</h2>

  <label>1. Просим подтвердить ваше участие:</label>
  <label><input type="radio" name="attendance" value="Придем" required> Придем</label>
  <label><input type="radio" name="attendance" value="Не сможем присутствовать"> Не сможем присутствовать</label>

  <div id="guestCountSection" style="display:none;">
    <label>2. Укажите количество гостей от семьи:</label>
    <div id="guestCountOptions">
      <label><input type="radio" name="guestCount" value="1"> 1</label>
      <label><input type="radio" name="guestCount" value="2"> 2</label>
      <label><input type="radio" name="guestCount" value="3"> 3</label>
      <label><input type="radio" name="guestCount" value="4"> 4</label>
      <label><input type="radio" name="guestCount" value="5"> 5</label>
      <label><input type="radio" name="guestCount" value="6"> 6</label>
    </div>
  </div>

  <div id="guestDetailsSection"></div>

  <label>6. Откуда вы к нам приедете?</label>
  <input type="text" name="fromWhere" placeholder="Город или адрес" required>

  <button type="submit" disabled>Отправить</button>
</form>

<script>
  const form = document.getElementById('surveyForm');
  const guestCountSection = document.getElementById('guestCountSection');
  const guestDetailsSection = document.getElementById('guestDetailsSection');
  const submitButton = form.querySelector('button[type="submit"]');

  // Показать блок выбора гостей только если "Придем"
  function toggleGuestCountSection() {
    const attendanceRadios = form.elements['attendance'];
    let attendance = null;
    for (const radio of attendanceRadios) {
      if (radio.checked) {
        attendance = radio.value;
        break;
      }
    }
    if (attendance === 'Придем') {
      guestCountSection.style.display = 'block';
    } else {
      guestCountSection.style.display = 'none';
      guestDetailsSection.innerHTML = '';
    }
    validateForm();
  }

  // Создать блоки гостей с ФИО, аллергией и алкоголем
  function createGuestFields(count) {
    guestDetailsSection.innerHTML = '';

    for(let i=1; i<=count; i++) {
      const guestBlock = document.createElement('div');
      guestBlock.className = 'guest-block';

      const guestTitle = document.createElement('h4');
      guestTitle.textContent = `Гость ${i}`;
      guestBlock.appendChild(guestTitle);

      // ФИО
      const fioLabel = document.createElement('label');
      fioLabel.textContent = 'ФИО:';
      const fioInput = document.createElement('input');
      fioInput.type = 'text';
      fioInput.name = `guestFIO_${i}`;
      fioInput.placeholder = 'ФИО';
      fioInput.required = true;

      // Аллергия
      const allergyLabel = document.createElement('label');
      allergyLabel.textContent = 'Есть ли аллергия на какую-то еду?';
      const allergyInput = document.createElement('input');
      allergyInput.type = 'text';
      allergyInput.name = `guestAllergy_${i}`;
      allergyInput.placeholder = 'Если есть, укажите';
      allergyInput.required = false;

      // Алкоголь
      const alcoholLabel = document.createElement('label');
      alcoholLabel.textContent = 'Какой алкоголь вы предпочитаете?';
      const alcoholSelect = document.createElement('select');
      alcoholSelect.name = `guestAlcohol_${i}`;
      alcoholSelect.required = true;

      const options = ['Красное вино', 'Белое вино', 'Самогон', 'Не пью алкоголь'];
      options.forEach(opt => {
        const optionEl = document.createElement('option');
        optionEl.value = opt;
        optionEl.textContent = opt;
        alcoholSelect.appendChild(optionEl);
      });

      guestBlock.appendChild(fioLabel);
      guestBlock.appendChild(fioInput);
      guestBlock.appendChild(allergyLabel);
      guestBlock.appendChild(allergyInput);
      guestBlock.appendChild(alcoholLabel);
      guestBlock.appendChild(alcoholSelect);

      guestDetailsSection.appendChild(guestBlock);
    }
  }

  // Отслеживаем выбор участия
  const attendanceRadios = form.elements['attendance'];
  for (const radio of attendanceRadios) {
    radio.addEventListener('change', () => {
      toggleGuestCountSection();
    });
  }

  // Отслеживаем выбор количества гостей
  const guestCountRadios = form.elements['guestCount'];
  if (guestCountRadios) {
    for (const radio of guestCountRadios) {
      radio.addEventListener('change', e => {
        createGuestFields(parseInt(e.target.value));
        validateForm();
      });
    }
  }

  // Валидация всех обязательных полей для активации кнопки
  function validateForm() {
    // Проверяем участие
    let attendance = null;
    for (const radio of attendanceRadios) {
      if (radio.checked) {
        attendance = radio.value;
        break;
      }
    }
    if (!attendance) {
      submitButton.disabled = true;
      return;
    }

    if (attendance === 'Придем') {
      // Проверяем выбор количества гостей
      const guestCountRadio = [...form.elements['guestCount']].find(r => r.checked);
      if (!guestCountRadio) {
        submitButton.disabled = true;
        return;
      }
      const guestCount = parseInt(guestCountRadio.value);

      // Проверяем поля каждого гостя
      for (let i = 1; i <= guestCount; i++) {
        const fio = form.elements[`guestFIO_${i}`];
        const alcohol = form.elements[`guestAlcohol_${i}`];
        if (!fio.value.trim() || !alcohol.value) {
          submitButton.disabled = true;
          return;
        }
      }
    }

    // Проверяем поле "Откуда приедете"
    if (!form.elements['fromWhere'].value.trim()) {
      submitButton.disabled = true;
      return;
    }

    submitButton.disabled = false;
  }

  form.addEventListener('input', validateForm);

  // Изначально скрываем секцию гостей
  guestCountSection.style.display = 'none';
  submitButton.disabled = true;

  // Отправка данных на Google Apps Script
  form.addEventListener('submit', e => {
    e.preventDefault();

    let attendance = null;
    for (const radio of attendanceRadios) {
      if (radio.checked) {
        attendance = radio.value;
        break;
      }
    }

    let guestCount = 0;
    if (attendance === 'Придем') {
      const guestCountRadio = [...form.elements['guestCount']].find(r => r.checked);
      guestCount = guestCountRadio ? parseInt(guestCountRadio.value) : 0;
    }

    const guests = [];
    for (let i = 1; i <= guestCount; i++) {
      guests.push({
        fio: form.elements[`guestFIO_${i}`].value.trim(),
        allergy: form.elements[`guestAllergy_${i}`].value.trim(),
        alcohol: form.elements[`guestAlcohol_${i}`].value
      });
    }

    const data = {
      attendance,
      guestCount,
      guests,
      fromWhere: form.elements['fromWhere'].value.trim()
    };

    const scriptUrl = 'https://script.google.com/macros/s/AKfycbw0lwmbGh944HTrzqHuzxZXMBH1HjZcZbtT7dYxfb1d3RlL_EO3gXzUWIlZ3QG8QEEU/exec';

    fetch(scriptUrl, {
      method: 'POST',
      body: JSON.stringify(data),
      headers: {'Content-Type': 'application/json'}
    })
    .then(response => {
      if (response.ok) {
        alert('Спасибо за ответ!');
        form.reset();
        guestDetailsSection.innerHTML = '';
        guestCountSection.style.display = 'none';
        submitButton.disabled = true;
      } else {
        alert('Ошибка при отправке, попробуйте позже.');
      }
    })
    .catch(() => alert('Ошибка связи, проверьте интернет.'));
  });
</script>

</body>
</html>