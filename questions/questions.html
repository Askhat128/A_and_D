<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>RSVP Форма</title>
  <style>
    .hidden { display: none; }
    .guest-block { margin-bottom: 20px; border: 1px solid #ccc; padding: 10px; border-radius: 8px; }
    button:active { transform: scale(0.98); }
  </style>
</head>
<body>
  <h2>Подтвердите ваше участие</h2>

  <form id="rsvpForm">
    <label>
      <input type="radio" name="attendance" value="yes"> Придем
    </label>
    <label>
      <input type="radio" name="attendance" value="no"> Не сможем присутствовать
    </label>

    <div id="nonAttendanceBlock" class="hidden">
      <h3>ФИО</h3>
      <input type="text" id="singleName">
    </div>

    <div id="attendanceBlock" class="hidden">
      <label>Укажите количество гостей от семьи:</label><br>
      <label><input type="radio" name="guestCount" value="1"> 1</label>
      <label><input type="radio" name="guestCount" value="2"> 2</label>
      <label><input type="radio" name="guestCount" value="3"> 3</label>
      <label><input type="radio" name="guestCount" value="4"> 4</label>
      <label><input type="radio" name="guestCount" value="5"> 5</label>
      <label><input type="radio" name="guestCount" value="6"> 6</label>

      <div id="guestFields"></div>

      <label for="city">Откуда вы к нам приедете?</label><br>
      <input type="text" id="city">
    </div>

    <br>
    <button type="submit">Отправить</button>
  </form>

  <script>
    const form = document.getElementById('rsvpForm');
    const attendanceRadios = document.getElementsByName('attendance');
    const guestFields = document.getElementById('guestFields');
    const attendanceBlock = document.getElementById('attendanceBlock');
    const nonAttendanceBlock = document.getElementById('nonAttendanceBlock');

    attendanceRadios.forEach(radio => {
      radio.addEventListener('change', () => {
        const isComing = radio.value === 'yes';

        // Переключение блоков
        attendanceBlock.classList.toggle('hidden', !isComing);
        nonAttendanceBlock.classList.toggle('hidden', isComing);

        // Очистка полей
        guestFields.innerHTML = '';
        document.getElementById('city').value = '';
        document.getElementById('singleName').value = '';

        // Установка required
        document.getElementById('singleName').required = !isComing;
        document.getElementById('city').required = isComing;

        // Удаляем required у полей гостей
        document.querySelectorAll('[name^="fio"], [name^="alcohol"], [name^="allergy"]').forEach(el => {
          el.required = false;
        });
      });
    });

    document.querySelectorAll('input[name="guestCount"]').forEach(radio => {
      radio.addEventListener('change', () => {
        const count = parseInt(radio.value);
        guestFields.innerHTML = '';
        for (let i = 1; i <= count; i++) {
          guestFields.innerHTML += `
            <div class="guest-block">
              <h4>Гость №${i}</h4>
              <label>ФИО:</label><br>
              <input type="text" name="fio${i}" required><br>

              <label>Какой алкоголь вы предпочитаете?</label><br>
              <select name="alcohol${i}">
                <option>Красное вино</option>
                <option>Белое вино</option>
                <option>Коньяк</option>
                <option>Самогон</option>
                <option>Не пью алкоголь</option>
              </select><br>

              <label>Есть ли аллергия?<br><small>Укажите, у кого в семье аллергия и на какие продукты.</small></label><br>
              <input type="text" name="allergy${i}">
            </div>
          `;
        }
      });
    });

    form.addEventListener('submit', async function(event) {
      event.preventDefault();

      const timestamp = new Date().toLocaleString('ru-RU');
      const participation = document.querySelector('input[name="attendance"]:checked').value;

      if (participation === 'no') {
        const fullName = document.getElementById('singleName').value;
        const data = {
          num: 1,
          timestamp,
          participation: "Нет",
          fio: fullName,
          alcohol: '',
          allergy: '',
          city: ''
        };
        await sendToSheet(data);
        alert("Спасибо! Ответ записан.");
        form.reset();
        guestFields.innerHTML = '';
        attendanceBlock.classList.add('hidden');
        nonAttendanceBlock.classList.add('hidden');
        return;
      }

      const city = document.getElementById('city').value;
      const guestCount = parseInt(document.querySelector('input[name="guestCount"]:checked').value);

      for (let i = 1; i <= guestCount; i++) {
        const fio = document.querySelector(`[name="fio${i}"]`).value;
        const alcohol = document.querySelector(`[name="alcohol${i}"]`).value;
        const allergy = document.querySelector(`[name="allergy${i}"]`).value;

        const data = {
          num: i,
          timestamp,
          participation: "Да",
          fio,
          alcohol,
          allergy,
          city
        };

        await sendToSheet(data);
      }

      alert("Спасибо! Все гости записаны.");
      form.reset();
      guestFields.innerHTML = '';
      attendanceBlock.classList.add('hidden');
      nonAttendanceBlock.classList.add('hidden');
    });

    async function sendToSheet(data) {
      await fetch('https://script.google.com/macros/s/ВАШ_URL_СКРИПТА/exec', {
        method: 'POST',
        body: JSON.stringify(data)
      });
    }
  </script>
</body>
</html>
