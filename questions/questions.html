<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>RSVP</title>
  <style>
    body {
      background-image: url('images/bg.jpg');
      background-size: cover;
      background-position: center;
      font-family: sans-serif;
      padding: 20px;
    }

    form {
      background-color: rgba(255,255,255,0.9);
      padding: 20px;
      border-radius: 10px;
      max-width: 800px;
      margin: auto;
    }

    .guest-block {
      background: #f0f0f0;
      padding: 10px;
      margin: 10px 0;
      border-radius: 6px;
    }

    .hidden {
      display: none;
    }
  </style>
</head>
<body>

<form id="rsvpForm">
  <h3>1. Подтвердите ваше участие:</h3>
  <label><input type="radio" name="attendance" value="yes" required> Придем</label><br>
  <label><input type="radio" name="attendance" value="no"> Не сможем присутствовать</label>

  <div id="not-coming" class="hidden">
    <label>ФИО:</label>
    <input type="text" name="fio_no" id="fio_no">
    <p>Нам очень жаль, но спасибо за поздравление.</p>
  </div>

  <div id="coming" class="hidden">
    <label>2. Сколько вас будет?</label>
    <select id="guestCount" required>
      <option value=\"\">Выберите</option>
      <option>1</option><option>2</option><option>3</option>
      <option>4</option><option>5</option><option>6</option>
    </select>

    <div id="guests"></div>

    <label>4. Откуда вы приедете?</label>
    <input type="text" id="locationInput" required>
  </div>

  <br>
  <button type="submit" id="submitBtn" disabled>Отправить</button>
  <p id="statusMsg"></p>
</form>

<script>
  const attendanceRadios = document.getElementsByName('attendance');
  const notComingBlock = document.getElementById('not-coming');
  const comingBlock = document.getElementById('coming');
  const guestCount = document.getElementById('guestCount');
  const guestsDiv = document.getElementById('guests');
  const locationInput = document.getElementById('locationInput');
  const submitBtn = document.getElementById('submitBtn');
  const statusMsg = document.getElementById('statusMsg');

  function validateForm() {
    const attendance = [...attendanceRadios].find(r => r.checked)?.value;

    if (attendance === 'no') {
      return document.getElementById('fio_no').value.trim() !== '';
    }

    if (attendance === 'yes') {
      const count = parseInt(guestCount.value);
      if (!count || !locationInput.value.trim()) return false;

      for (let i = 1; i <= count; i++) {
        if (
          !document.getElementById(`guest_fio_${i}`).value.trim() ||
          !document.getElementById(`guest_alcohol_${i}`).value ||
          !document.getElementById(`guest_allergy_${i}`).value.trim()
        ) {
          return false;
        }
      }
      return true;
    }

    return false;
  }

  document.getElementById('rsvpForm').addEventListener('input', () => {
    submitBtn.disabled = !validateForm();
  });

  attendanceRadios.forEach(radio => {
    radio.addEventListener('change', () => {
      const value = radio.value;

      if (value === 'no') {
        notComingBlock.classList.remove('hidden');
        comingBlock.classList.add('hidden');
        guestCount.value = '';
        guestsDiv.innerHTML = '';
        locationInput.value = '';
      } else {
        comingBlock.classList.remove('hidden');
        notComingBlock.classList.add('hidden');
        document.getElementById('fio_no').value = '';
      }

      submitBtn.disabled = !validateForm();
    });
  });

  guestCount.addEventListener('change', () => {
    guestsDiv.innerHTML = '';
    const count = parseInt(guestCount.value);
    for (let i = 1; i <= count; i++) {
      guestsDiv.innerHTML += `
        <div class="guest-block">
          <h4>Гость ${i}</h4>
          <label>ФИО:</label>
          <input type="text" id="guest_fio_${i}">
          <label>Какой алкоголь предпочитаете?</label>
          <select id="guest_alcohol_${i}">
            <option value="">Выберите</option>
            <option>Красное вино</option>
            <option>Белое вино</option>
            <option>Самогон</option>
            <option>Не пью алкоголь</option>
          </select>
          <label>Есть ли аллергия?</label>
          <input type="text" id="guest_allergy_${i}">
        </div>
      `;
    }
    submitBtn.disabled = !validateForm();
  });

  document.getElementById('rsvpForm').addEventListener('submit', function (e) {
    e.preventDefault();

    const attendance = [...attendanceRadios].find(r => r.checked)?.value;

    let formData = {
      attendance
    };

    if (attendance === 'no') {
      formData.fio_no = document.getElementById('fio_no').value;
    } else {
      const count = parseInt(guestCount.value);
      formData.guest_count = count;
      formData.location = locationInput.value;

      for (let i = 1; i <= count; i++) {
        formData[`guest_${i}_fio`] = document.getElementById(`guest_fio_${i}`).value;
        formData[`guest_${i}_alcohol`] = document.getElementById(`guest_alcohol_${i}`).value;
        formData[`guest_${i}_allergy`] = document.getElementById(`guest_allergy_${i}`).value;
      }
    }

    fetch('https://script.google.com/macros/s/AKfycbyPpeoLWUwP8rElR-Cvxwr67xohzEnzlPAhpLD1_RuzraPUzsHK_Ndl9fP9NOIuXc8O8g/exec', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(formData)
    })
    .then(res => res.text())
    .then(response => {
      statusMsg.innerText = 'Форма успешно отправлена!';
      document.getElementById('rsvpForm').reset();
      notComingBlock.classList.add('hidden');
      comingBlock.classList.add('hidden');
      guestsDiv.innerHTML = '';
      submitBtn.disabled = true;
    })
    .catch(err => {
      console.error(err);
      statusMsg.innerText = 'Ошибка отправки: ' + err;
    });
  });
</script>

</body>
</html>
